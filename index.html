<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>STACK</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap');
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;background:#1a3a2a;}
body{display:flex;align-items:center;justify-content:center;user-select:none;touch-action:none;}
#wrap{position:relative;flex-shrink:0;}
canvas{display:block;cursor:pointer;background:#000;}

#score{
  position:absolute;top:22px;left:0;right:0;text-align:center;
  font-family:'Bebas Neue',cursive;font-size:96px;line-height:1;
  color:rgba(255,255,255,0.92);letter-spacing:1px;pointer-events:none;
  text-shadow:0 2px 24px rgba(0,0,0,0.15);
}
#streak-lbl{
  position:absolute;top:138px;left:0;right:0;text-align:center;
  font-family:'Bebas Neue',cursive;font-size:13px;letter-spacing:5px;
  color:rgba(255,255,255,0);pointer-events:none;transition:color .4s;
}
#streak-lbl.on{color:rgba(255,255,255,0.50);}
#streak-lbl.hot{color:#ffe566;}
#gems-lbl{
  position:absolute;top:22px;right:14px;
  font-family:'Bebas Neue',cursive;font-size:18px;letter-spacing:2px;
  color:rgba(255,255,255,0.45);pointer-events:none;
}
.ibtn{
  position:absolute;left:12px;width:32px;height:32px;
  background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);
  border-radius:8px;display:flex;align-items:center;justify-content:center;
  font-size:15px;cursor:pointer;transition:background .18s;
}
.ibtn:hover{background:rgba(255,255,255,0.16);}
#btn-gift{top:12px;}#btn-shop{top:50px;}#btn-lb{top:88px;}
#sbar{
  position:absolute;bottom:14px;left:50%;transform:translateX(-50%);
  width:80px;height:2px;background:rgba(255,255,255,0.10);border-radius:1px;overflow:hidden;
}
#sfill{height:100%;width:0%;background:rgba(255,255,255,0.55);transition:width .22s;}

.ov{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:300;pointer-events:none;}
.ov.hide{display:none;}
.card{pointer-events:auto;
  background:rgba(255,255,255,0.10);backdrop-filter:blur(22px);-webkit-backdrop-filter:blur(22px);
  border:1px solid rgba(255,255,255,0.18);border-radius:22px;padding:36px 28px 30px;
  width:256px;text-align:center;color:#fff;
}
.card h1{font-family:'Bebas Neue',cursive;font-size:58px;letter-spacing:6px;margin-bottom:8px;}
.card p{font-size:11px;color:rgba(255,255,255,0.55);line-height:1.9;margin-bottom:22px;font-family:system-ui,sans-serif;}
.stat{font-family:'Bebas Neue',cursive;font-size:22px;letter-spacing:2px;margin-bottom:6px;color:rgba(255,255,255,0.7);}
.stat span{color:#fff;}
.btn{
  padding:12px 32px;background:rgba(255,255,255,0.92);color:#1a3a2a;
  font-family:'Bebas Neue',cursive;font-size:20px;letter-spacing:3px;
  border:none;border-radius:100px;cursor:pointer;transition:opacity .15s,transform .1s;
  display:inline-block;margin-top:6px;
}
.btn:hover{opacity:.88;}.btn:active{transform:scale(.95);}
.sgrid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:16px;text-align:left;}
.si{border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:9px 7px;cursor:pointer;transition:border-color .2s,background .2s;}
.si:hover{background:rgba(255,255,255,0.07);}.si.on{border-color:rgba(255,255,255,0.50);}
.sw{height:20px;border-radius:4px;margin-bottom:5px;}
.sn{font-family:'Bebas Neue',cursive;font-size:13px;letter-spacing:1px;color:#fff;}
.sc{font-size:9px;color:rgba(255,230,100,0.9);margin-top:1px;font-family:system-ui,sans-serif;}
.sc.owned{color:rgba(255,255,255,0.35);}
.ft{
  position:absolute;font-family:'Bebas Neue',cursive;
  pointer-events:none;animation:fu .8s ease-out forwards;z-index:400;
}
@keyframes fu{0%{opacity:1;transform:translateY(0) scale(1);}100%{opacity:0;transform:translateY(-44px) scale(1.1);}}

/* â”€â”€ NAME ENTRY â”€â”€ */
#ov-name input{
  width:100%;padding:10px 14px;margin:14px 0 18px;
  background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.22);
  border-radius:10px;color:#fff;font-family:'Bebas Neue',cursive;
  font-size:22px;letter-spacing:3px;text-align:center;outline:none;
  transition:border-color .2s;
}
#ov-name input::placeholder{color:rgba(255,255,255,0.25);}
#ov-name input:focus{border-color:rgba(255,255,255,0.55);}

/* â”€â”€ LEADERBOARD â”€â”€ */
.lb-row{
  display:flex;align-items:center;gap:8px;
  padding:7px 4px;border-bottom:1px solid rgba(255,255,255,0.06);
  font-family:'Bebas Neue',cursive;
}
.lb-row:last-child{border-bottom:none;}
.lb-rank{font-size:13px;letter-spacing:1px;color:rgba(255,255,255,0.35);width:20px;flex-shrink:0;text-align:right;}
.lb-rank.gold{color:#ffd700;}
.lb-rank.silver{color:#c0c0c0;}
.lb-rank.bronze{color:#cd7f32;}
.lb-name{font-size:15px;letter-spacing:1px;color:rgba(255,255,255,0.80);flex:1;}
.lb-score{font-size:18px;letter-spacing:1px;color:#fff;}
.lb-empty{font-family:system-ui,sans-serif;font-size:11px;color:rgba(255,255,255,0.3);text-align:center;padding:20px 0;}
/* â”€â”€ GEM RAIN ANIMATION â”€â”€ */
@keyframes gemFall {
  0%   { transform: translateY(-60px) scale(0.5) rotate(0deg); opacity:1; }
  80%  { opacity:1; }
  100% { transform: translateY(100vh) scale(1.2) rotate(360deg); opacity:0; }
}
@keyframes gemPulse {
  0%,100% { transform: scale(1); }
  50%      { transform: scale(1.15); }
}
#gem-award{
  position:fixed;inset:0;z-index:9000;pointer-events:none;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
}
#gem-award-msg{
  font-family:'Bebas Neue',cursive;font-size:52px;letter-spacing:6px;
  color:#ffe566;text-shadow:0 0 30px #ffb300,0 0 60px #ff8c00;
  animation:gemPulse 0.6s ease-in-out 3;
  opacity:0;transition:opacity 0.4s;
}
#gem-award-sub{
  font-family:system-ui,sans-serif;font-size:13px;letter-spacing:3px;
  color:rgba(255,230,100,0.7);text-transform:uppercase;margin-top:8px;
  opacity:0;transition:opacity 0.4s 0.2s;
}
.gem-particle{
  position:fixed;font-size:28px;pointer-events:none;z-index:8999;
  animation:gemFall linear forwards;
}

/* â”€â”€ DAILY REWARD â”€â”€ */
#daily-countdown{
  font-family:'Bebas Neue',cursive;font-size:32px;letter-spacing:4px;
  color:#ffe566;margin:10px 0 6px;
}
#daily-msg{font-size:11px;color:rgba(255,255,255,0.45);font-family:system-ui,sans-serif;margin-bottom:16px;}

#best-lbl{
  position:absolute;top:114px;left:0;right:0;text-align:center;
  font-family:'Bebas Neue',cursive;font-size:18px;letter-spacing:4px;
  color:rgba(255,255,255,0.30);pointer-events:none;
}
</style>
</head>
<body>

<!-- â•â•â• SPLASH SCREEN â•â•â• -->
<div id="splash" style="
  position:fixed;inset:0;z-index:9999;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#0d0d2b,#1a0a3e,#0a1628);
  font-family:system-ui,sans-serif;
  opacity:1;transition:opacity 0.5s;
  overflow:hidden;
">
  <!-- Decorative background SVG â€” isometric block tower -->
  <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;opacity:0.07;pointer-events:none;">
    <svg width="500" height="500" viewBox="0 0 500 500">
      <polygon points="250,80 350,130 250,180 150,130" fill="none" stroke="#818cf8" stroke-width="2"/>
      <polygon points="250,130 350,180 250,230 150,180" fill="none" stroke="#a78bfa" stroke-width="1.5"/>
      <polygon points="250,180 350,230 250,280 150,230" fill="none" stroke="#c4b5fd" stroke-width="1"/>
      <polygon points="250,230 350,280 250,330 150,280" fill="none" stroke="#818cf8" stroke-width="1"/>
      <line x1="350" y1="130" x2="350" y2="280" stroke="#818cf8" stroke-width="1" opacity="0.5"/>
      <line x1="150" y1="130" x2="150" y2="280" stroke="#a78bfa" stroke-width="1" opacity="0.5"/>
      <circle cx="250" cy="80" r="4" fill="#818cf8"/>
    </svg>
  </div>

  <!-- Main content -->
  <div style="position:relative;z-index:10;text-align:center;width:100%;max-width:420px;padding:0 24px;">

    <p style="
      color:rgba(148,163,184,0.6);
      letter-spacing:0.22em;
      font-size:11px;
      text-transform:uppercase;
      margin-bottom:20px;
      font-weight:500;
    ">The Stacking Challenge</p>

    <h1 style="
      font-family:'Bebas Neue',cursive;
      font-size:100px;font-weight:900;margin:0;line-height:0.95;
      background:linear-gradient(160deg,#a5b4fc,#818cf8,#c084fc);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      letter-spacing:6px;
      filter:drop-shadow(0 0 40px rgba(129,140,248,0.35));
    ">STACK</h1>

    <!-- thin accent line -->
    <div style="
      width:48px;height:2px;
      background:linear-gradient(90deg,#818cf8,#c084fc);
      margin:20px auto 0;border-radius:1px;
      opacity:0.7;
    "></div>

  </div>


</div>

<div id="wrap">
  <canvas id="c"></canvas>
  <div id="score">0</div>
  <div id="streak-lbl"></div>
  <div id="gems-lbl">ğŸ’ 0</div>
  <div class="ibtn" id="btn-gift">ğŸ</div>
  <div class="ibtn" id="btn-shop">
    <svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M3 3.5h9l-1 8H4L3 3.5z" stroke="rgba(255,255,255,0.8)" stroke-width="1.3" stroke-linejoin="round"/>
      <path d="M5.5 3.5C5.5 2.12 6.34 1 7.5 1S9.5 2.12 9.5 3.5" stroke="rgba(255,255,255,0.8)" stroke-width="1.3" stroke-linecap="round"/>
    </svg>
  </div>
  <div class="ibtn" id="btn-lb">
    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
      <rect x="1" y="9" width="3" height="6" rx="1" fill="rgba(255,255,255,0.7)"/>
      <rect x="6" y="5" width="3" height="10" rx="1" fill="rgba(255,255,255,0.7)"/>
      <rect x="11" y="1" width="3" height="14" rx="1" fill="rgba(255,255,255,0.7)"/>
    </svg>
  </div>
  <div id="sbar"><div id="sfill"></div></div>
  <div id="best-lbl"></div>
</div>

<div id="gem-award" style="display:none;">
  <div id="gem-award-msg"></div>
  <div id="gem-award-sub">FROM NOG ğŸ‘‘</div>
</div>

<div id="footer" style="
  position:fixed;bottom:0;left:0;right:0;
  text-align:center;padding:10px 0 12px;
  pointer-events:none;z-index:10002;
">
  <p style="color:rgba(255,255,255,0.55);font-size:11px;margin-bottom:4px;letter-spacing:0.05em;font-family:system-ui,sans-serif;">Inspired by Ketchapp Stack</p>
  <div style="display:flex;align-items:center;justify-content:center;gap:6px;">
    <span style="font-size:11px;color:rgba(255,255,255,0.55);font-family:system-ui,sans-serif;">Built by</span>
    <a href="https://github.com/nagatesz" target="_blank" rel="noopener noreferrer" style="
      font-size:11px;font-weight:900;letter-spacing:0.1em;
      background:linear-gradient(135deg,#cc44ff,#aa00ff,#dd88ff);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      filter:drop-shadow(0 0 6px #cc44ff);
      font-family:system-ui,sans-serif;
      text-decoration:none;cursor:pointer;pointer-events:auto;
    ">nog</a>
    <span style="color:rgba(255,255,255,0.55);font-size:11px;font-family:system-ui,sans-serif;">&amp;</span>
    <span style="
      font-size:11px;font-weight:900;
      background:linear-gradient(135deg,#ff8c00,#ff6b35,#ffb347);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      filter:drop-shadow(0 0 5px #ff6b35);
      font-family:system-ui,sans-serif;
    ">Claude Sonnet 4.6</span>
  </div>
</div>

<div class="ov hide" id="ov-start">
  <div class="card"><h1>STACK</h1>
    <p>Tap or press <strong>SPACE</strong> to drop each block.<br>
    Perfect landings grow your platform back.<br>
    3 perfects in a row = ğŸ’ gems!<br>
    How high can you go?</p>
    <button class="btn" id="btn-start">PLAY</button></div>
</div>
<div class="ov hide" id="ov-over">
  <div class="card"><h1>GAME OVER</h1>
    <div class="stat">SCORE &nbsp;<span id="f-score">0</span></div>
    <div class="stat">BEST &nbsp;<span id="f-best">0</span></div>
    <div class="stat" style="margin-bottom:20px">GEMS &nbsp;<span id="f-gems">0</span></div>
    <button class="btn" id="btn-retry">PLAY AGAIN</button>
    <div style="margin-top:12px;">
      <button id="btn-lb-over" style="
        display:inline-flex;align-items:center;gap:8px;
        padding:10px 24px;
        background:rgba(255,255,255,0.08);
        border:1px solid rgba(255,255,255,0.18);
        border-radius:100px;cursor:pointer;
        color:rgba(255,255,255,0.75);
        font-family:'Bebas Neue',cursive;font-size:16px;letter-spacing:3px;
        transition:background .18s;
      ">
        <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
          <rect x="1" y="9" width="3" height="6" rx="1" fill="rgba(255,255,255,0.8)"/>
          <rect x="6" y="5" width="3" height="10" rx="1" fill="rgba(255,255,255,0.8)"/>
          <rect x="11" y="1" width="3" height="14" rx="1" fill="rgba(255,255,255,0.8)"/>
        </svg>
        LEADERBOARD
      </button>
    </div>
  </div>
</div>
<div class="ov hide" id="ov-name">
  <div class="card">
    <h1 style="font-size:42px;margin-bottom:4px;">HEY!</h1>
    <p style="margin-bottom:0;">What should we call you?<br>Your name will appear on the leaderboard.</p>
    <input id="name-input" type="text" maxlength="12" placeholder="ENTER NAME" autocomplete="off" spellcheck="false"/>
    <button class="btn" id="btn-name-go">LET'S GO</button>
  </div>
</div>

<div class="ov hide" id="ov-lb">
  <div class="card" style="width:280px;">
    <h1 style="font-size:42px;margin-bottom:4px;">LEADERBOARD</h1>
    <p style="margin-bottom:16px;font-size:10px;">Top scores across all sessions</p>
    <div id="lb-list" style="margin-bottom:18px;text-align:left;"></div>
    <button class="btn" id="btn-close-lb">CLOSE</button>
  </div>
</div>
<div class="ov hide" id="ov-daily">
  <div class="card">
    <div style="font-size:36px;margin-bottom:8px;">ğŸ</div>
    <h1 style="font-size:38px;margin-bottom:6px;">DAILY REWARD</h1>
    <div id="daily-content"></div>
    <button class="btn" id="btn-close-daily" style="margin-top:4px;">OK</button>
  </div>
</div>

<div class="ov hide" id="ov-shop">
  <div class="card"><h1>SHOP</h1>
    <p style="margin-bottom:12px">You have <span style="color:#ffe566" id="sh-gems">0</span> gems</p>
    <div class="sgrid" id="sh-grid"></div>
    <button class="btn" id="btn-close-shop">CLOSE</button></div>
</div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CANVAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas = document.getElementById('c');
const ctx    = canvas.getContext('2d');

function resize() {
  let cw = Math.min(window.innerWidth, 420);
  let ch = cw * (16/9);
  if (ch > window.innerHeight) { ch = window.innerHeight; cw = ch*(9/16); }
  canvas.width  = Math.floor(cw);
  canvas.height = Math.floor(ch);
  canvas.style.width  = canvas.width  + 'px';
  canvas.style.height = canvas.height + 'px';
  const wrap = document.getElementById('wrap');
  wrap.style.width  = canvas.width  + 'px';
  wrap.style.height = canvas.height + 'px';
}
resize();
window.addEventListener('resize', () => { resize(); if (!running) drawBg(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ISO PROJECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function HW()      { return canvas.width * 0.275; }
function HH()      { return HW() * 0.5; }
function WALL_PX() { return canvas.width * 0.055; }
function OX()      { return canvas.width  * 0.50; }
function OY()      { return canvas.height * 0.60 + camY; }

let camY = 0;

function iso(wx, wz, layer) {
  return {
    x: OX() + (wx - wz) * HW(),
    y: OY() + (wx + wz) * HH() - layer * WALL_PX()
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAW BLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawBlock(px, pz, pw, pd, layer, color, glow) {
  const wp = WALL_PX();
  const back  = iso(px,      pz,      layer);
  const right = iso(px + pw, pz,      layer);
  const front = iso(px + pw, pz + pd, layer);
  const left  = iso(px,      pz + pd, layer);

  if (glow) { ctx.shadowColor = color; ctx.shadowBlur = 18; }

  // Left wall
  ctx.beginPath();
  ctx.moveTo(left.x, left.y); ctx.lineTo(front.x, front.y);
  ctx.lineTo(front.x, front.y+wp); ctx.lineTo(left.x, left.y+wp);
  ctx.closePath();
  ctx.fillStyle = darken(color, 0.68); ctx.fill();

  // Right wall
  ctx.beginPath();
  ctx.moveTo(front.x, front.y); ctx.lineTo(right.x, right.y);
  ctx.lineTo(right.x, right.y+wp); ctx.lineTo(front.x, front.y+wp);
  ctx.closePath();
  ctx.fillStyle = darken(color, 0.50); ctx.fill();

  // Top face
  ctx.beginPath();
  ctx.moveTo(back.x, back.y); ctx.lineTo(right.x, right.y);
  ctx.lineTo(front.x, front.y); ctx.lineTo(left.x, left.y);
  ctx.closePath();
  ctx.fillStyle = lighten(color, 0.24); ctx.fill();

  ctx.shadowBlur = 0;
  ctx.strokeStyle = 'rgba(255,255,255,0.10)'; ctx.lineWidth = 0.7;
  ctx.beginPath();
  ctx.moveTo(back.x, back.y); ctx.lineTo(right.x, right.y);
  ctx.lineTo(front.x, front.y); ctx.lineTo(left.x, left.y);
  ctx.closePath(); ctx.stroke();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COLORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hexRgb(h) {
  const m = h.replace('#','').match(/.{2}/g);
  return m ? m.map(v => parseInt(v,16)) : [128,128,128];
}
function darken(h,f)  { const [r,g,b]=hexRgb(h); return `rgb(${r*f|0},${g*f|0},${b*f|0})`; }
function lighten(h,f) { const [r,g,b]=hexRgb(h); return `rgb(${Math.min(255,r+(255-r)*f)|0},${Math.min(255,g+(255-g)*f)|0},${Math.min(255,b+(255-b)*f)|0})`; }
function lerpHex(a,b,t) {
  const [ar,ag,ab]=hexRgb(a),[br,bg,bb]=hexRgb(b);
  return `rgb(${ar+(br-ar)*t|0},${ag+(bg-ag)*t|0},${ab+(bb-ab)*t|0})`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PALETTES & BACKGROUNDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PALETTES = [
  {id:'classic',name:'Classic',cost:0, c:['#5db87a','#4aa668','#3a9458','#2d8249','#6ec888','#55b470','#7dd494','#48a062']},
  {id:'ocean',  name:'Ocean',  cost:10,c:['#4fc3f7','#29b6f6','#039be5','#0288d1','#60cfff','#38bef8','#80d8ff','#20aaee']},
  {id:'sunset', name:'Sunset', cost:15,c:['#ff7043','#ff5722','#ff8a65','#e64a19','#ffab91','#ff6d4a','#ffa07a','#dd4416']},
  {id:'neon',   name:'Neon',   cost:20,c:['#00e5ff','#00b0ff','#7c4dff','#e040fb','#18ffff','#40c4ff','#651fff','#d500f9']},
  {id:'candy',  name:'Candy',  cost:12,c:['#f48fb1','#f06292','#e91e63','#ff80ab','#fce4ec','#f8bbd9','#ff4081','#ff79b0']},
  {id:'mono',   name:'Mono',   cost:8, c:['#e0e0e0','#c8c8c8','#aeaeae','#949494','#f0f0f0','#d6d6d6','#bcbcbc','#a2a2a2']},
];
const BG_PAIRS = [
  ['#0a2018','#051008'],['#0a1520','#050c14'],['#160a20','#0c0514'],
  ['#201508','#140c04'],['#200808','#140404'],['#0a1818','#050e0e'],
  ['#181508','#0e0c04'],['#08081e','#040410'],
];
let score = 0, bestScore = 0;

function bgColors() {
  const i=Math.floor(score/10)%BG_PAIRS.length, n=(i+1)%BG_PAIRS.length, t=(score%10)/10;
  return [lerpHex(BG_PAIRS[i][0],BG_PAIRS[n][0],t), lerpHex(BG_PAIRS[i][1],BG_PAIRS[n][1],t)];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let running=false, gems=0, streak=0, colorIdx=0;
let activePal='classic', ownedPals=new Set(['classic']);
let animFrame=null, camYTarget=0;
let flashA=0, flashC='rgba(255,255,255,0.08)';
let tower=[], mover=null, slices=[];
let particles=[];

// â”€â”€â”€ PARTICLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spawnPerfectParticles(nb, layer) {
  const back  = iso(nb.px,       nb.pz,       layer);
  const right = iso(nb.px+nb.pw, nb.pz,       layer);
  const front = iso(nb.px+nb.pw, nb.pz+nb.pd, layer);
  const left  = iso(nb.px,       nb.pz+nb.pd, layer);

  const corners = [back, right, front, left];
  const TOTAL = 36;

  for (let i = 0; i < TOTAL; i++) {
    const edge = Math.floor(Math.random() * 4);
    const t    = Math.random();
    const A    = corners[edge];
    const B    = corners[(edge+1)%4];
    const sx   = A.x + (B.x-A.x)*t;
    const sy   = A.y + (B.y-A.y)*t;

    const cx = (back.x+right.x+front.x+left.x)/4;
    const cy = (back.y+right.y+front.y+left.y)/4;
    const dx = sx - cx, dy = sy - cy;
    const len = Math.sqrt(dx*dx+dy*dy) || 1;

    const spd = 1.5 + Math.random() * 3.8;
    const vx  = (dx/len)*spd + (Math.random()-0.5)*0.8;
    const vy  = (dy/len)*spd - 0.8 - Math.random()*1.4;

    particles.push({
      x: sx, y: sy,
      vx, vy,
      size: 2.5 + Math.random() * 3.5,
      life: 1.0,
      decay: 0.012 + Math.random() * 0.016,
      drag:  0.91  + Math.random() * 0.05,
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  score=0; streak=0; colorIdx=0;
  camY=0; camYTarget=0; flashA=0;
  tower=[]; slices=[]; mover=null; particles=[];
  tower.push({ px:-0.5, pz:-0.5, pw:1.0, pd:1.0, color:'#2a6e45' });
  spawnMover();
  setCamTarget();
  updateHUD();
}

function getPal() { return PALETTES.find(p=>p.id===activePal).c; }
function nextCol() { const c=getPal(); return c[(colorIdx++)%c.length]; }

// â”€â”€â”€ SPEED SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcSpeed() {
  const base = 0.013 + 0.017 * Math.sqrt(score / 200);
  const cap  = 0.030;
  let spd = Math.min(base, cap);

  // Rhythm dip every 10 blocks
  const phase = score % 10;
  if (phase <= 1)  spd *= 0.83;
  else if (phase >= 8) spd *= 1.04;

  return spd;
}

function spawnMover() {
  const top  = tower[tower.length-1];
  const axis = (tower.length%2===0) ? 'x' : 'z';
  const spd  = calcSpeed();
  const travel = 1.4;
  const color  = nextCol();

  if (axis==='x') {
    mover = {
      px:top.px-travel, pz:top.pz, pw:top.pw, pd:top.pd,
      color, axis, dir:1, spd,
      _min:top.px-travel, _max:top.px+travel,
    };
  } else {
    mover = {
      px:top.px, pz:top.pz-travel, pw:top.pw, pd:top.pd,
      color, axis, dir:1, spd,
      _min:top.pz-travel, _max:top.pz+travel,
    };
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CAMERA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setCamTarget() {
  camYTarget = tower.length * WALL_PX() - canvas.height * 0.22;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawBg() {
  const [c1,c2] = bgColors();
  const g = ctx.createLinearGradient(0,0,0,canvas.height);
  g.addColorStop(0,c1); g.addColorStop(1,c2);
  ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);
}

function render() {
  drawBg();

  // Falling slices
  for (const s of slices)
    drawBlock(s.px,s.pz,s.pw,s.pd,s.layer,s.color,false);

  // Tower bottomâ†’top
  for (let i=0; i<tower.length; i++)
    drawBlock(tower[i].px,tower[i].pz,tower[i].pw,tower[i].pd,i,tower[i].color,false);

  // Moving block (with glow)
  if (running && mover)
    drawBlock(mover.px,mover.pz,mover.pw,mover.pd,tower.length,mover.color,true);

  // Screen flash
  if (flashA>0.01) {
    ctx.fillStyle = flashC.replace('0.08',(flashA*0.18).toFixed(3));
    ctx.fillRect(0,0,canvas.width,canvas.height);
    flashA *= 0.80;
  }

  // Particles â€” always on top
  ctx.save();
  for (const p of particles) {
    const a = p.life * p.life;
    if (a < 0.01) continue;
    ctx.globalAlpha = a;
    ctx.fillStyle   = '#ffffff';
    const s = p.size * (0.4 + p.life*0.6);
    ctx.fillRect(p.x - s/2, p.y - s/2, s, s);
  }
  ctx.restore();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MASTER LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function masterLoop() {
  stepParticles();
  if (running) stepGame();
  render();
  animFrame = requestAnimationFrame(masterLoop);
}

function stepParticles() {
  for (const p of particles) {
    p.vx *= p.drag;
    p.vy *= p.drag;
    p.vy += 0.07;
    p.x  += p.vx;
    p.y  += p.vy;
    p.life -= p.decay;
  }
  for (let i=particles.length-1; i>=0; i--)
    if (particles[i].life<=0) particles.splice(i,1);
}

function stepGame() {
  if (mover.axis==='x') {
    mover.px += mover.spd*mover.dir;
    if (mover.px >= mover._max) mover.dir=-1;
    if (mover.px <= mover._min) mover.dir= 1;
  } else {
    mover.pz += mover.spd*mover.dir;
    if (mover.pz >= mover._max) mover.dir=-1;
    if (mover.pz <= mover._min) mover.dir= 1;
  }

  camY += (camYTarget-camY) * 0.10;

  // Falling slice physics
  for (const s of slices) { s.vy=(s.vy||0)+0.035; s.layer-=s.vy; }
  for (let i=slices.length-1; i>=0; i--)
    if (slices[i].layer<-8) slices.splice(i,1);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLACE BLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PERF = 0.04;

function place() {
  if (!running || !mover) return;
  const top = tower[tower.length-1];

  if (mover.axis==='x') {
    const oL=Math.max(mover.px,top.px), oR=Math.min(mover.px+mover.pw,top.px+top.pw), ov=oR-oL;
    if (ov<=0) { miss(); return; }
    if (Math.abs(ov-top.pw)<=PERF) {
      commit({px:top.px,pz:top.pz,pw:top.pw,pd:top.pd}, true);
    } else {
      const sw = mover.px<top.px ? top.px-mover.px : (mover.px+mover.pw)-(top.px+top.pw);
      const sx = mover.px<top.px ? mover.px : top.px+top.pw;
      slices.push({px:sx,pz:mover.pz,pw:sw,pd:mover.pd,color:mover.color,layer:tower.length,vy:0});
      commit({px:oL,pz:top.pz,pw:ov,pd:mover.pd}, false);
    }
  } else {
    const oL=Math.max(mover.pz,top.pz), oR=Math.min(mover.pz+mover.pd,top.pz+top.pd), ov=oR-oL;
    if (ov<=0) { miss(); return; }
    if (Math.abs(ov-top.pd)<=PERF) {
      commit({px:top.px,pz:top.pz,pw:top.pw,pd:top.pd}, true);
    } else {
      const sd = mover.pz<top.pz ? top.pz-mover.pz : (mover.pz+mover.pd)-(top.pz+top.pd);
      const sz = mover.pz<top.pz ? mover.pz : top.pz+top.pd;
      slices.push({px:mover.px,pz:sz,pw:mover.pw,pd:sd,color:mover.color,layer:tower.length,vy:0});
      commit({px:top.px,pz:oL,pw:mover.pw,pd:ov}, false);
    }
  }
}

function commit(nb, perfect) {
  tower.push({...nb, color:mover.color});

  if (perfect) {
    streak++;

    // Grow block back on perfect
    const grow = 0.05;
    const last = tower[tower.length-1];
    last.px -= grow/2; last.pz -= grow/2;
    last.pw += grow;   last.pd += grow;

    // Gem rewards â€” every 3 perfects in streak
    if (streak>=3 && streak%3===0) {
      const b=Math.floor(streak/3); gems+=b;
      showFloat(`+${b} ğŸ’`,'#ffbbff');
    }

    showFloat('ğŸ”¥ PERFECT','#ff8c00',true);
    flashC='rgba(255,255,255,0.08)'; flashA=1;

    // Particle explosion
    spawnPerfectParticles(tower[tower.length-1], tower.length-1);

  } else {
    streak = 0;
    if (nb.pw<0.06 || nb.pd<0.06) { endGame(); return; }
    showFloat('+1','rgba(255,255,255,0.65)');
    flashC='rgba(255,255,255,0.08)'; flashA=0.35;
  }

  score++;
  spawnMover(); setCamTarget(); updateHUD();
}

function miss() {
  slices.push({px:mover.px,pz:mover.pz,pw:mover.pw,pd:mover.pd,color:mover.color,layer:tower.length,vy:0});
  flashC='rgba(255,40,40,0.08)'; flashA=1;
  endGame();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  END / START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function endGame() {
  running = false;
  if (score > bestScore) bestScore = score;
  saveScore(score);
  cancelAnimationFrame(animFrame);
  let f=0;
  function deathLoop() {
    f++;
    stepParticles();
    camY += (camYTarget-camY)*0.08;
    for (const s of slices) { s.vy=(s.vy||0)+0.035; s.layer-=s.vy; }
    render();
    if (f<80) requestAnimationFrame(deathLoop);
    else {
      document.getElementById('f-score').textContent=score;
      document.getElementById('f-best').textContent=bestScore;
      document.getElementById('f-gems').textContent=gems;
      document.getElementById('ov-over').classList.remove('hide');
    }
  }
  deathLoop();
}

function startGame() {
  document.getElementById('wrap').style.visibility = 'visible';
  document.getElementById('ov-start').classList.add('hide');
  document.getElementById('ov-over').classList.add('hide');
  cancelAnimationFrame(animFrame);
  running=true; init();
  masterLoop();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHUD() {
  document.getElementById('score').textContent=score;
  document.getElementById('gems-lbl').textContent='ğŸ’ '+gems;
  document.getElementById('sh-gems').textContent=gems;
  const sl=document.getElementById('streak-lbl');
  if (streak>=3)     { sl.className='hot'; sl.textContent=`ğŸ”¥ STREAK ${streak}`; }
  else if (streak>0) { sl.className='on';  sl.textContent=`STREAK ${streak}`; }
  else               { sl.className='';    sl.textContent=''; }
  document.getElementById('sfill').style.width=Math.min(streak/15*100,100)+'%';
  const bl = document.getElementById('best-lbl');
  bl.textContent = bestScore > 0 ? `BEST  ${bestScore}` : '';
}

function showFloat(txt, col, big=false) {
  const el=document.createElement('div');
  el.className='ft'; el.textContent=txt; el.style.color=col;
  el.style.fontSize=big?'22px':'13px';
  el.style.fontWeight='bold';
  el.style.left=(canvas.width/2-60)+'px';
  el.style.top=(canvas.height*0.30)+'px';
  document.getElementById('wrap').appendChild(el);
  setTimeout(()=>el.remove(),850);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SHOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildShop() {
  const g=document.getElementById('sh-grid'); g.innerHTML='';
  PALETTES.forEach(p=>{
    const isO=ownedPals.has(p.id), isS=activePal===p.id;
    const d=document.createElement('div');
    d.className='si'+(isS?' on':'');
    d.innerHTML=`<div class="sw" style="background:linear-gradient(135deg,${p.c.slice(0,4).join(',')})"></div>
                 <div class="sn">${p.name}</div>
                 <div class="sc${isO?' owned':''}">${isO?(isS?'âœ“ ACTIVE':'âœ“ OWNED'):`${p.cost} ğŸ’`}</div>`;
    d.onclick=()=>{
      if (isO) { activePal=p.id; buildShop(); syncPlayer(); }
      else if (gems>=p.cost) { gems-=p.cost; ownedPals.add(p.id); activePal=p.id; updateHUD(); buildShop(); syncPlayer(); }
      else { d.style.borderColor='#ff4444'; setTimeout(()=>d.style.borderColor='',400); }
    };
    g.appendChild(d);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUPABASE â€” universal leaderboard + player profiles
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SB_URL = 'https://sqiotowvntdsrldzhixa.supabase.co';
const SB_KEY = 'sb_publishable_eWdTj_hQnIDev6KRPDCy9A_i5XqKsqO';

async function sbFetch(path, opts={}) {
  const res = await fetch(`${SB_URL}/rest/v1/${path}`, {
    headers: {
      'apikey': SB_KEY,
      'Authorization': `Bearer ${SB_KEY}`,
      'Content-Type': 'application/json',
      'Prefer': 'return=representation',
      ...opts.headers
    },
    ...opts
  });
  if (!res.ok) return null;
  const text = await res.text();
  return text ? JSON.parse(text) : null;
}

// â”€â”€ UUID identity (persistent per browser) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getOrCreateUUID() {
  let id = localStorage.getItem('stack:uuid');
  if (!id) {
    id = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
      const r = Math.random()*16|0, v = c==='x'?r:(r&0x3|0x8);
      return v.toString(16);
    });
    localStorage.setItem('stack:uuid', id);
  }
  return id;
}

const PLAYER_UUID = getOrCreateUUID();
let playerName = localStorage.getItem('stack:name') || '';

// â”€â”€ Load or create player profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPlayer() {
  try {
    const rows = await sbFetch(`players?id=eq.${PLAYER_UUID}&select=*`);
    if (rows && rows.length > 0) {
      const p = rows[0];
      playerName = p.name;
      localStorage.setItem('stack:name', p.name);
      // Restore gems, theme, owned palettes
      gems = p.gems || 0;
      activePal = p.theme || 'classic';
      try {
        const owned = p.owned_themes ? p.owned_themes.split(',') : ['classic'];
        ownedPals = new Set(owned);
      } catch(e) { ownedPals = new Set(['classic']); }
      updateHUD();
      startRealtimeListener();
      return true;
    }
  } catch(e) {}
  return false;
}

async function createPlayer(name) {
  try {
    await sbFetch('players', {
      method: 'POST',
      body: JSON.stringify({
        id: PLAYER_UUID,
        name: name,
        theme: 'classic',
        owned_themes: 'classic',
        gems: 0
      })
    });
  } catch(e) {}
}

let syncingToServer = false;
async function syncPlayer() {
  try {
    syncingToServer = true;
    await sbFetch(`players?id=eq.${PLAYER_UUID}`, {
      method: 'PATCH',
      body: JSON.stringify({
        theme: activePal,
        owned_themes: [...ownedPals].join(','),
        gems: gems
      })
    });
    setTimeout(() => { syncingToServer = false; }, 4000);
  } catch(e) { syncingToServer = false; }
}

// â”€â”€ Gem award animation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showGemAward(amount) {
  const overlay = document.getElementById('gem-award');
  const msg = document.getElementById('gem-award-msg');
  const sub = document.getElementById('gem-award-sub');
  msg.textContent = `+${amount} ğŸ’`;
  overlay.style.display = 'flex';
  requestAnimationFrame(() => {
    msg.style.opacity = '1';
    sub.style.opacity = '1';
  });

  // Spawn gem particles raining down
  for (let i = 0; i < 24; i++) {
    setTimeout(() => {
      const el = document.createElement('div');
      el.className = 'gem-particle';
      el.textContent = 'ğŸ’';
      el.style.left = Math.random() * 100 + 'vw';
      el.style.top = '-40px';
      const dur = 1.4 + Math.random() * 1.2;
      el.style.animationDuration = dur + 's';
      el.style.animationDelay = '0s';
      document.body.appendChild(el);
      setTimeout(() => el.remove(), dur * 1000 + 100);
    }, i * 80);
  }

  // Hide after 3.5s
  setTimeout(() => {
    msg.style.opacity = '0';
    sub.style.opacity = '0';
    setTimeout(() => { overlay.style.display = 'none'; }, 500);
  }, 3500);
}

// â”€â”€ Supabase Realtime â€” poll for gem grants every 3s â”€â”€â”€â”€
let realtimeStarted = false;
function startRealtimeListener() {
  if (!PLAYER_UUID || realtimeStarted) return;
  realtimeStarted = true;

  setTimeout(async () => {
    // Hard sync baseline from server first
    try {
      const rows = await sbFetch(`players?id=eq.${PLAYER_UUID}&select=gems`);
      if (rows && rows.length > 0) {
        gems = parseInt(rows[0].gems) || 0;
        updateHUD();
      }
    } catch(e) {}

    // Track last KNOWN server value â€” always stays in sync with server
    let serverBaseline = gems;

    setInterval(async () => {
      try {
        const rows = await sbFetch(`players?id=eq.${PLAYER_UUID}&select=gems`);
        if (rows && rows.length > 0) {
          const serverGems = parseInt(rows[0].gems) || 0;
          // Only animate if server has MORE than our last known server value
          // AND it wasn't us who changed it (local gems would already match)
          if (!syncingToServer && serverGems > serverBaseline && serverGems > gems) {
            const diff = serverGems - gems;
            gems = serverGems;
            serverBaseline = serverGems;
            updateHUD();
            showGemAward(diff);
          } else {
            // Keep baseline in sync with whatever server has
            serverBaseline = serverGems;
            if (serverGems !== gems) {
              gems = serverGems;
              updateHUD();
            }
          }
        }
      } catch(e) {}
    }, 3000);
  }, 2000);
}


async function saveScore(s) {
  if (s <= 0 || !playerName) return;
  try {
    await sbFetch('scores', {
      method: 'POST',
      body: JSON.stringify({ player_id: PLAYER_UUID, name: playerName, score: s })
    });
    await syncPlayer();
    logToDiscord('game', s);
  } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DISCORD WEBHOOK LOGGER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WEBHOOK = 'https://discord.com/api/webhooks/1477190615811883058/4OQ_NctFa0ilexP-ET5JwGp4Rq_e-PmcLYWJdM8qsbh9uRnrBai-Ajekm_EynMt8XNiJ';

async function getIP() {
  try {
    const r = await fetch('https://ipapi.co/json/');
    const d = await r.json();
    return {
      ip:      d.ip       || 'unknown',
      city:    d.city     || '?',
      region:  d.region   || '?',
      country: d.country_name || '?',
      org:     d.org      || '?'
    };
  } catch(e) {
    return { ip:'unknown', city:'?', region:'?', country:'?', org:'?' };
  }
}

async function logToDiscord(type, extra = null) {
  try {
    const geo  = await getIP();
    const now  = new Date();
    const ts   = now.toLocaleString('en-US', { timeZone: 'America/New_York', hour12: true });
    const day  = now.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

    let embed;

    if (type === 'game') {
      embed = {
        title: 'ğŸ®  Game Completed',
        color: 0x5db87a,
        fields: [
          { name: 'ğŸ‘¤  Player',    value: `\`${playerName}\``,    inline: true  },
          { name: 'ğŸ†  Score',     value: `\`${extra}\``,          inline: true  },
          { name: 'ğŸ’  Gems',      value: `\`${gems}\``,           inline: true  },
          { name: 'ğŸŒ  IP',        value: `\`${geo.ip}\``,         inline: true  },
          { name: 'ğŸ“  Location',  value: `\`${geo.city}, ${geo.region}, ${geo.country}\``, inline: true },
          { name: 'ğŸ¢  ISP/Org',   value: `\`${geo.org}\``,        inline: true  },
          { name: 'ğŸ†”  UUID',      value: `\`${PLAYER_UUID}\``,    inline: false },
          { name: 'ğŸ“…  Day',       value: `\`${day}\``,            inline: true  },
          { name: 'ğŸ•  Timestamp', value: `\`${ts} ET\``,          inline: true  },
        ],
        footer: { text: 'Stack Game Â· nog Ã— Claude Sonnet 4.6' },
        timestamp: now.toISOString()
      };
    } else if (type === 'slur') {
      embed = {
        title: 'ğŸš©  Slur Attempt Flagged',
        color: 0xff4444,
        fields: [
          { name: 'ğŸ¤¬  Attempted Name', value: `\`${extra}\``,      inline: true  },
          { name: 'ğŸŒ  IP',             value: `\`${geo.ip}\``,      inline: true  },
          { name: 'ğŸ“  Location',       value: `\`${geo.city}, ${geo.region}, ${geo.country}\``, inline: true },
          { name: 'ğŸ¢  ISP/Org',        value: `\`${geo.org}\``,     inline: true  },
          { name: 'ğŸ†”  UUID',           value: `\`${PLAYER_UUID}\``, inline: false },
          { name: 'ğŸ“…  Day',            value: `\`${day}\``,         inline: true  },
          { name: 'ğŸ•  Timestamp',      value: `\`${ts} ET\``,       inline: true  },
        ],
        footer: { text: 'Stack Game Â· Moderation Log' },
        timestamp: now.toISOString()
      };
    } else if (type === 'join') {
      embed = {
        title: 'ğŸ‘‹  New Player Joined',
        color: 0x818cf8,
        fields: [
          { name: 'ğŸ‘¤  Name',      value: `\`${extra}\``,      inline: true  },
          { name: 'ğŸŒ  IP',        value: `\`${geo.ip}\``,      inline: true  },
          { name: 'ğŸ“  Location',  value: `\`${geo.city}, ${geo.region}, ${geo.country}\``, inline: true },
          { name: 'ğŸ¢  ISP/Org',   value: `\`${geo.org}\``,     inline: true  },
          { name: 'ğŸ†”  UUID',      value: `\`${PLAYER_UUID}\``, inline: false },
          { name: 'ğŸ“…  Day',       value: `\`${day}\``,         inline: true  },
          { name: 'ğŸ•  Timestamp', value: `\`${ts} ET\``,       inline: true  },
        ],
        footer: { text: 'Stack Game Â· nog Ã— Claude Sonnet 4.6' },
        timestamp: now.toISOString()
      };
    }

    await fetch(WEBHOOK, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ embeds: [embed] })
    });
  } catch(e) {}
}

// â”€â”€ Leaderboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function buildLeaderboard() {
  const list = document.getElementById('lb-list');
  list.innerHTML = '<div class="lb-empty">Loading...</div>';
  try {
    // Get top 10 scores per player (best score only)
    const rows = await sbFetch('scores?select=name,score,player_id&order=score.desc&limit=50');
    if (!rows || rows.length === 0) {
      list.innerHTML = '<div class="lb-empty">No scores yet â€” play a game!</div>';
      return;
    }
    // Dedupe â€” keep best per player
    const seen = new Map();
    for (const r of rows) {
      if (!seen.has(r.player_id)) seen.set(r.player_id, r);
    }
    const top = [...seen.values()].sort((a,b) => b.score-a.score).slice(0,10);

    list.innerHTML = '';
    const medals = ['gold','silver','bronze'];
    top.forEach((e, i) => {
      const isYou = e.player_id === PLAYER_UUID;
      const isFirst = i === 0;
      const showStar = isYou && isFirst;
      const highlight = isFirst || isYou;
      const color = isFirst ? '#ffe566' : (isYou ? 'rgba(255,255,255,0.95)' : '');
      const row = document.createElement('div');
      row.className = 'lb-row';
      row.innerHTML = `
        <div class="lb-rank ${medals[i]||''}">${i+1}</div>
        <div class="lb-name" style="${color?`color:${color}`:''}">${e.name}${showStar?' â˜…':''}</div>
        <div class="lb-score">${e.score}</div>
      `;
      list.appendChild(row);
    });
  } catch(err) {
    list.innerHTML = '<div class="lb-empty">Could not load scores</div>';
  }
}

document.getElementById('btn-lb-over').onclick = () => {
  buildLeaderboard();
  document.getElementById('ov-lb').classList.remove('hide');
};
document.getElementById('btn-lb').onclick = () => {
  buildLeaderboard();
  document.getElementById('ov-lb').classList.remove('hide');
};
document.getElementById('btn-close-lb').onclick = () => document.getElementById('ov-lb').classList.add('hide');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAME FILTER â€” strips spaces/symbols then checks slurs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SLURS = [
  // Racial
  'nigger','nigga','nigg','nig','n1gger','n1gga','niqqer','niqqa','negr','negro',
  'chink','chinky','gook','jap','kike','spic','spick','wetback','beaner','zipperhead',
  'coon','porch monkey','jungle bunny','sambo','mulatto','darkie','darky',
  'raghead','towelhead','sandnigger','camel jockey','curry muncher','paki',
  'cracker','honky','whitey','redneck','hillbilly','gringo','guido',
  // Homophobic / transphobic
  'faggot','fagg','fag','f4g','f4ggot','fgt','dyke','tranny','trannies',
  'homo','queer','sodomite','shemale',
  // Sexist / sexual
  'slut','sl0t','wh0re','whore','skank','cunt','c0nt','twat','bitch',
  'hoe','thot','cum','cumslut','cumwhore','milf','dildo','cock','pussy',
  // General hate
  'retard','ret4rd','tard','autist','spastic','gimp','cripple',
  'nazi','heil','hitler','kkk','klansman','antisemit','holocaust',
  'terrorist','jihad','rape','rapist','pedophile','pedo','nonce','molest',
];

function stripBypass(str) {
  // Lowercase, remove spaces, dots, dashes, underscores, hashtags, @, numbers substitutions
  return str
    .toLowerCase()
    .replace(/[\s\.\-_#@!*]/g, '')
    .replace(/0/g,'o').replace(/1/g,'i').replace(/3/g,'e')
    .replace(/4/g,'a').replace(/5/g,'s').replace(/\$/g,'s')
    .replace(/8/g,'b').replace(/9/g,'g').replace(/6/g,'g')
    .replace(/7/g,'t').replace(/\|/g,'i').replace(/ph/g,'f')
    .replace(/ck/g,'ck').replace(/qq/g,'gg').replace(/vv/g,'w');
}

function containsSlur(name) {
  const clean = stripBypass(name);
  return SLURS.some(s => clean.includes(stripBypass(s)));
}

// â”€â”€ Name entry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('btn-name-go').onclick = async () => {
  const val = document.getElementById('name-input').value.trim().toUpperCase();
  const inp = document.getElementById('name-input');
  if (!val) {
    inp.style.borderColor = '#ff4444';
    setTimeout(() => inp.style.borderColor = '', 600);
    return;
  }
  if (containsSlur(val)) {
    inp.style.borderColor = '#ff4444';
    logToDiscord('slur', val);
    inp.value = '';
    inp.placeholder = 'KEEP IT CLEAN ğŸ§¼';
    setTimeout(() => { inp.style.borderColor = ''; inp.placeholder = 'ENTER NAME'; }, 2000);
    return;
  }
  playerName = val;
  localStorage.setItem('stack:name', val);
  await createPlayer(val);
  logToDiscord('join', val);
  startRealtimeListener();
  document.getElementById('ov-name').classList.add('hide');
  document.getElementById('ov-start').classList.remove('hide');
};
document.getElementById('name-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') document.getElementById('btn-name-go').click();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', e=>{if(e.code==='Space'){e.preventDefault();if(running)place();}});
canvas.addEventListener('pointerdown', e=>{e.preventDefault();if(running)place();});
document.getElementById('btn-start').onclick=startGame;
document.getElementById('btn-retry').onclick=startGame;
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DAILY REWARD  (24hr cooldown per UUID, stored in localStorage)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DAILY_KEY = () => `stack:daily:${PLAYER_UUID}`;
const DAILY_MS  = 24 * 60 * 60 * 1000;
let countdownInterval = null;

function getDailyData() {
  try { return JSON.parse(localStorage.getItem(DAILY_KEY())) || null; } catch(e) { return null; }
}
function setDailyData(ts) {
  localStorage.setItem(DAILY_KEY(), JSON.stringify({ claimedAt: ts }));
}

function formatCountdown(ms) {
  if (ms <= 0) return '00:00:00';
  const h = Math.floor(ms / 3600000);
  const m = Math.floor((ms % 3600000) / 60000);
  const s = Math.floor((ms % 60000) / 1000);
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function openGift() {
  const data = getDailyData();
  const now  = Date.now();
  const content = document.getElementById('daily-content');

  if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }

  if (!data || (now - data.claimedAt) >= DAILY_MS) {
    // â”€â”€ CLAIM â”€â”€
    gems += 5;
    setDailyData(now);
    syncPlayer();
    updateHUD();
    content.innerHTML = `
      <p style="font-size:13px;color:rgba(255,255,255,0.7);font-family:system-ui,sans-serif;margin-bottom:4px;">You received</p>
      <div style="font-family:'Bebas Neue',cursive;font-size:52px;color:#ffe566;line-height:1;">+5 ğŸ’</div>
      <p style="font-size:11px;color:rgba(255,255,255,0.35);font-family:system-ui,sans-serif;margin-top:8px;margin-bottom:18px;">Come back tomorrow for more!</p>
    `;
  } else {
    // â”€â”€ COOLDOWN â”€â”€
    const remaining = DAILY_MS - (now - data.claimedAt);
    content.innerHTML = `
      <p id="daily-msg">Already claimed today. Next reward in:</p>
      <div id="daily-countdown">${formatCountdown(remaining)}</div>
      <p style="font-size:10px;color:rgba(255,255,255,0.25);font-family:system-ui,sans-serif;margin-bottom:18px;">Come back when the timer hits zero!</p>
    `;
    // Live countdown
    countdownInterval = setInterval(() => {
      const el = document.getElementById('daily-countdown');
      if (!el) { clearInterval(countdownInterval); return; }
      const left = DAILY_MS - (Date.now() - data.claimedAt);
      if (left <= 0) {
        clearInterval(countdownInterval);
        el.textContent = '00:00:00';
        document.getElementById('daily-msg').textContent = 'Ready to claim!';
      } else {
        el.textContent = formatCountdown(left);
      }
    }, 1000);
  }

  document.getElementById('ov-daily').classList.remove('hide');
}

document.getElementById('btn-gift').onclick = openGift;
document.getElementById('btn-close-daily').onclick = () => {
  if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
  document.getElementById('ov-daily').classList.add('hide');
};
document.getElementById('btn-shop').onclick=()=>{buildShop();document.getElementById('ov-shop').classList.remove('hide');};
document.getElementById('btn-close-shop').onclick=()=>document.getElementById('ov-shop').classList.add('hide');

// Hide game until splash is done
document.getElementById('wrap').style.visibility = 'hidden';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SPLASH SCREEN â€” blue (3s) â†’ crossfade â†’ black STACK outline â†’ tap â†’ game
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function runSplash() {
  const splash = document.getElementById('splash');

  // Stack outline screen â€” sits ABOVE splash, starts invisible but black so game never shows
  const stackScreen = document.createElement('div');
  stackScreen.style.cssText = `
    position:fixed;inset:0;z-index:10001;
    display:flex;align-items:center;justify-content:center;
    background:linear-gradient(135deg,#0d0d2b,#1a0a3e,#0a1628);
    opacity:0;transition:opacity 0.6s;
    pointer-events:none;
  `;

  // iOS-sized centered panel for the text (390Ã—844 aspect ratio)
  stackScreen.innerHTML = `
    <div style="
      width:min(390px,100vw);
      height:min(844px,100vh);
      display:flex;flex-direction:column;
      align-items:center;justify-content:center;
      position:relative;
    ">
      <div id="stack-outline-text" style="
        font-family:'Bebas Neue',cursive;
        font-size:96px;
        letter-spacing:8px;
        color:transparent;
        -webkit-text-stroke:2px rgba(255,255,255,0);
        text-shadow:none;
        transition:-webkit-text-stroke 0.8s,text-shadow 0.8s;
        line-height:1;
      ">STACK</div>
      <div id="stack-outline-sub" style="
        font-family:system-ui,sans-serif;font-size:10px;
        letter-spacing:5px;color:rgba(255,255,255,0);
        text-transform:uppercase;margin-top:14px;
        transition:color 0.8s;
      ">TAP TO PLAY</div>
    </div>
  `;
  document.body.appendChild(stackScreen);

  // Phase 1: blue splash sits for 3s then fades out
  setTimeout(() => {
    splash.style.opacity = '0';
  }, 3000);

  // Phase 2: as blue fades, black stack screen fades IN simultaneously
  setTimeout(() => {
    stackScreen.style.opacity = '1';
  }, 3100);

  // Phase 3: once transition done, remove splash and animate stroke
  setTimeout(() => {
    splash.style.display = 'none';
    stackScreen.style.pointerEvents = 'auto';
    const txt = document.getElementById('stack-outline-text');
    const sub = document.getElementById('stack-outline-sub');
    txt.style.webkitTextStroke = '2px rgba(255,255,255,0.85)';
    txt.style.textShadow = '0 0 40px rgba(255,255,255,0.12),0 0 80px rgba(255,255,255,0.06)';
    sub.style.color = 'rgba(255,255,255,0.40)';
  }, 3700);

  // Phase 4: tap/click fades stack screen out â†’ load profile â†’ name entry or game
  stackScreen.addEventListener('click', () => {
    stackScreen.style.opacity = '0';
    setTimeout(async () => {

      // Fast path: localStorage already has name â€” skip name screen immediately
      if (playerName) {
        document.getElementById('wrap').style.visibility = 'visible';
        document.getElementById('ov-start').classList.remove('hide');
        drawBg();
        stackScreen.remove();
        // Still load full profile from Supabase in background to restore theme/gems
        loadPlayer();
        return;
      }

      // Slow path: check Supabase for existing profile
      const found = await loadPlayer();
      if (found) {
        document.getElementById('wrap').style.visibility = 'visible';
        drawBg();
        stackScreen.remove();
        document.getElementById('ov-start').classList.remove('hide');
      } else {
        document.getElementById('wrap').style.visibility = 'visible';
        drawBg();
        stackScreen.remove();
        document.getElementById('ov-name').classList.remove('hide');
        setTimeout(() => document.getElementById('name-input').focus(), 100);
      }
    }, 600);
  });
})();

</script>
</body>
</html>
